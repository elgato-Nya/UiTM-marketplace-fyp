name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20.x"

jobs:
  deploy:
    name: Deploy Full Stack to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Build React App
        working-directory: client
        run: |
          npm ci
          npm run build
        env:
          CI: false
          REACT_APP_ENVIRONMENT: production
          REACT_APP_API_URL: http://${{ secrets.EC2_HOST }}:5000
          REACT_APP_STRIPE_PUBLISHABLE_KEY: pk_test_51S8W3mJg56CMs4rbFNQy9iOSCDP91SLVMvJwWKIsHULGvp9r6ebVbjQ7vpa5Wn1ru0ZNlwEIkws92kk5Fhdn7fWH0086zCsjgI

      - name: Upload Build to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "client/build"
          target: "/home/ubuntu/uitm-marketplace"
          strip_components: 0

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Set error handling
            set -e

            # Define app directory (customize this to your EC2 path)
            APP_DIR="/home/ubuntu/uitm-marketplace"

            echo "üöÄ Starting deployment..."

            # Navigate to app directory
            cd $APP_DIR

            # Pull latest code from GitHub (with error recovery)
            echo "üì• Pulling latest code from main branch..."
            git fetch origin main
            git reset --hard origin/main || echo "‚ö†Ô∏è Git reset failed, continuing..."

            # ========== BACKEND DEPLOYMENT ==========
            echo "üîß Deploying backend..."
            cd $APP_DIR/server

            # Check if Node.js is available
            if ! command -v node &> /dev/null; then
              echo "‚ùå Node.js not found! Please install Node.js first."
              exit 1
            fi

            # Install production dependencies
            echo "üì¶ Installing server dependencies..."
            npm ci --only=production

            # Create/update .env file (optional - if you manage env via GitHub Secrets)
            # Uncomment if you want to inject .env from GitHub Secrets:
            # echo "${{ secrets.SERVER_ENV_FILE }}" > .env

            # Check if .env exists
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è Warning: .env file not found in server directory"
            fi

            # Restart backend with PM2
            echo "üîÑ Restarting backend service..."
            if ! command -v pm2 &> /dev/null; then
              echo "üì¶ Installing PM2 globally..."
              sudo npm install -g pm2
            fi

            if pm2 describe uitm-marketplace-server > /dev/null 2>&1; then
              pm2 restart uitm-marketplace-server
            else
              pm2 start index.js --name uitm-marketplace-server --env production
            fi
            pm2 save

            # ========== FRONTEND DEPLOYMENT ==========
            echo "üé® Deploying pre-built frontend..."
            cd $APP_DIR/client

            # Verify build folder exists (uploaded via SCP)
            if [ ! -d "build" ]; then
              echo "‚ùå Build folder not found! SCP upload may have failed."
              exit 1
            fi

            # Client is already built by GitHub Actions
            # Just install serve if not present
            if ! command -v serve &> /dev/null; then
              echo "üì¶ Installing serve globally..."
              sudo npm install -g serve
            fi

            # Restart client with PM2
            echo "üîÑ Restarting frontend service..."
            if pm2 describe uitm-marketplace-client > /dev/null 2>&1; then
              pm2 delete uitm-marketplace-client
            fi
            # Force serve to bind to 0.0.0.0 (accept external connections)
            pm2 start "serve -s build -l tcp://0.0.0.0:3000" --name uitm-marketplace-client
            pm2 save

            echo "‚úÖ Deployment completed successfully!"

            # Show PM2 status
            pm2 status

      - name: Health Check
        run: |
          echo "‚è≥ Waiting for services to start..."
          sleep 15

          # Check backend health
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:5000/api/health || echo "000")

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
            echo "‚úÖ Backend is responding (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Backend health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

          echo "üéâ Deployment verification passed!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above for details."
